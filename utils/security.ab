import { split_lines, match_regex, text_contains, starts_with } from "std/text"

// check_llm_output.sh (最终版)
//
// 按照严格的安全规则，检查LLM输出的脚本文件。
//
// --- 安全规则 ---
// 0. 禁止 Shebang (`#!`)
// 1. 允许空行 (^\s*$)。
// 2. 允许注释行 (^\s*#)。
// 3. 允许 `echo '...'` (单引号) 格式。
// 4. 允许 `echo "..."` (双引号) 格式，但前提是该行不包含 '$' 或 '`'。
// 5. 允许 `exit 201` 和 `exit 202`。
// --------------------

pub fun check_llm_output(script_content: Text): Bool {
    let lines = split_lines(script_content)

    for line in lines {
        // 规则 0: 禁止 Shebang
        if starts_with(line, "#!"):
            return false

        // 规则1: 禁止$和`
        if text_contains(line, "$") or text_contains(line, "`"):
            return false

        // 步骤 2: 检查是否为空行
        if match_regex(line, "^\s*$"):
            continue

        // 步骤 3: 检查是否为注释行
        if match_regex(line, "^\s*#.*$"):
            continue

        // 规则 4: 允许 echo '...' (单引号，内部不含')
        if match_regex(line, "^\s*echo\s+'[^']*'\s*$"):
            continue

        // 规则 5: 允许 echo "..." (双引号)，但需额外检查
        if match_regex(line, "^\s*echo\s+\"[^\"]*\"\s*$"):
            continue

        // 规则 5: 允许exit 201和exit 202
        if line == "exit 201" or line == "exit 202" :
            continue

        // 如果代码执行到这里，说明该行不符合任何已知的安全规则。
        return false
    }

    // 所有行都通过检查
    return true
}