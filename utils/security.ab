import { split_lines, text_contains, starts_with } from "std/text"

fun custom_match_regex(text: Text, pattern: Text): Bool {
    silent trust $ echo "{text}" | grep -qE -- "{pattern}" $
    return status == 0
}

// Checks the LLM output script file according to strict security rules.
//
// --- Security Rules ---
// 0. Disallow Shebang (`#!`).
// 1. Allow empty lines (^\s*$).
// 2. Allow comment lines (^\s*#).
// 3. Allow `echo '...'` (single quotes) format, supporting escaped quotes (\').
// 4. Allow `exit 201` and `exit 202`.
// --------------------

pub fun check_llm_output(script_content: Text): Bool {
    let lines = split_lines(script_content)

    for line in lines {
        // Rule 0: Disallow Shebang
        if starts_with(line, "#!"):
            return false

        // Step 1: Check for empty lines
        if custom_match_regex(line, "^\s*$"):
            continue

        // Step 2: Check for comment lines
        if custom_match_regex(line, "^\s*#.*$"):
            continue

        // Rule 3: Allow `echo '...'` (single quotes, supporting escaped quotes \' inside)
        if custom_match_regex(line, "^\s*echo\s+'([^']|\\\\')*'\s*$"):
            continue

        // Rule 4: Allow `exit 201` and `exit 202`
        if line == "exit 201" or line == "exit 202":
            continue

        // If the code reaches here, the line does not match any known safe patterns.
        return false
    }

    // All lines have passed the check.
    return true
}
