import { split_lines, text_contains, starts_with } from "std/text"

fun custom_match_regex(text: Text, pattern: Text): Bool {
    silent trust $ echo "{text}" | grep -qE -- "{pattern}" $
    return status == 0
}

// Checks the LLM output script file according to strict security rules.
//
// --- Security Rules ---
// 0. Disallow Shebang (`#!`).
// 1. Allow empty lines (^\s*$).
// 2. Allow comment lines (^\s*#).
// 3. Allow `echo '...'` (single quotes) format, supporting escaped quotes (\').
// 4. Allow `exit 201` and `exit 202`.
// --------------------

pub fun check_llm_output(script_content: Text): Bool {
    let lines = split_lines(script_content)

    for line in lines {
        // Rule 0: Disallow Shebang
        if starts_with(line, "#!"):
            return false

        // Step 1: Check for empty lines
        if custom_match_regex(line, "^\s*$"):
            continue

        // Step 2: Check for comment lines
        if custom_match_regex(line, "^\s*#.*$"):
            continue

        // Rule 3: Allow `echo '...'` (single quotes, supporting escaped quotes \' inside)
        if custom_match_regex(line, "^\s*echo\s+'([^']|\\\\')*'\s*$"):
            continue

        // Rule 4: Allow `exit 201` and `exit 202`
        if line == "exit 201" or line == "exit 202":
            continue

        // If the code reaches here, the line does not match any known safe patterns.
        return false
    }

    // All lines have passed the check.
    return true
}

fun run_test(description: Text, script: Text, expected: Bool): Bool {
    let actual = check_llm_output(script)
    if actual == expected {
        echo "✅ PASS: {description}"
        return true
    } else {
        echo "❌ FAIL: {description}"
        echo "     Expected: {expected}, Got: {actual}"
        return false
    }
}

main {
    // Test Suite for check_llm_output

    let passed_count = 0
    let failed_count = 0

    echo "--- Running Security Tests for check_llm_output ---"

    // --- Tests that should PASS (return true) ---
    if run_test("Empty script", "", true): passed_count += 1 else: failed_count += 1
    if run_test("Script with only comments and empty lines", "# A comment\n\n# Another comment", true): passed_count += 1 else: failed_count += 1
    if run_test("Simple echo with single quotes", "echo 'Hello World'", true): passed_count += 1 else: failed_count += 1
    if run_test("exit 201", "exit 201", true): passed_count += 1 else: failed_count += 1
    if run_test("exit 202", "exit 202", true): passed_count += 1 else: failed_count += 1
    if run_test(
        "A valid multi-line script",
        "echo 'First line'\n# A comment\nexit 201",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Single quotes containing special characters",
        "echo 'This string contains \" $ and ` characters'",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Single quotes with an escaped single quote",
        "echo 'It\\'s a beautiful day.'",
        true
    ): passed_count += 1 else: failed_count += 1

    // --- Tests that should FAIL (return false) ---
    if run_test("An unescaped single quote inside single quotes", "echo 'This isn't valid'", false): passed_count += 1 else: failed_count += 1
    if run_test("Script with a shebang", "#!/bin/bash\necho 'hello'", false): passed_count += 1 else: failed_count += 1
    if run_test("A simple double-quoted echo", "echo \"Hello World\"", false): passed_count += 1 else: failed_count += 1
    if run_test("Double quotes containing a dollar sign", "echo \"Hello $USER\"", false): passed_count += 1 else: failed_count += 1
    if run_test("Double quotes containing a backtick", "echo \"Hello `whoami`\"", false): passed_count += 1 else: failed_count += 1
    if run_test("An arbitrary command", "ls -la", false): passed_count += 1 else: failed_count += 1
    if run_test("A command with a semicolon", "echo 'hello'; ls", false): passed_count += 1 else: failed_count += 1
    if run_test("A comment after a valid command on the same line", "echo 'hello' # this is not allowed", false): passed_count += 1 else: failed_count += 1
    if run_test("An incomplete echo statement", "echo 'hello", false): passed_count += 1 else: failed_count += 1
    if run_test("A variable assignment using backticks", "let output = `ls`", false): passed_count += 1 else: failed_count += 1
    if run_test("A dollar sign outside of quotes", "echo $HOME", false): passed_count += 1 else: failed_count += 1


    echo "\n--- Test Summary ---"
    echo "Passed: {passed_count}"
    echo "Failed: {failed_count}"

    if failed_count > 0 {
        exit 1
    } else {
        echo "\nAll tests passed successfully!"
    }
}
