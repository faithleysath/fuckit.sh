import { split_lines, match_regex, text_contains, starts_with } from "std/text"

// Checks the LLM output script file according to strict security rules.
//
// --- Security Rules ---
// 0. Disallow Shebang (`#!`).
// 1. Allow empty lines (^\s*$).
// 2. Allow comment lines (^\s*#).
// 3. Allow `echo '...'` (single quotes) format.
// 4. Allow `echo "..."` (double quotes) format, but only if the line does not contain '$' or '`'.
// 5. Allow `exit 201` and `exit 202`.
// --------------------

pub fun check_llm_output(script_content: Text): Bool {
    let lines = split_lines(script_content)

    for line in lines {
        // Rule 0: Disallow Shebang
        if starts_with(line, "#!"):
            return false

        // Step 1: Check for empty lines
        if match_regex(line, "^\s*$"):
            continue

        // Step 2: Check for comment lines
        if match_regex(line, "^\s*#.*$"):
            continue

        // Rule 3: Allow `echo '...'` (single quotes, no ' inside)
        if match_regex(line, "^\s*echo\s+'[^']*'\s*$"):
            continue

        // Rule 4: Allow `echo "..."` (double quotes), but with an extra check for '$' or '`'
        if match_regex(line, "^\s*echo\s+\"[^\"]*\"\s*$") and not (text_contains(line, "$") or text_contains(line, "`")):
            continue

        // Rule 5: Allow `exit 201` and `exit 202`
        if line == "exit 201" or line == "exit 202":
            continue

        // If the code reaches here, the line does not match any known safe patterns.
        return false
    }

    // All lines have passed the check.
    return true
}
