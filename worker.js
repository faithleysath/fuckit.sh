// --- FUCKIT.SH Cloudflare Worker ---

// This is the content of your main.sh installer script.
// It will be served when a user makes a GET request.
const INSTALLER_SCRIPT = atob(`IyEvYmluL2Jhc2gKIwojIFRoaXMgc2NyaXB0IGlzIHRoZSBpbnN0YWxsZXIgYW5kIHRlbXBvcmFyeSBydW5uZXIgZm9yIGZ1Y2tpdC5zaAojCiMgLS0tIFJFQ09NTUVOREVEIFNFQ1VSRSBVU0FHRSAtLS0KIwojIDEuIERvd25sb2FkOgojICAgIGN1cmwgLW8gZnVja2l0LnNoIGh0dHBzOi8vZnVja2l0LnNoCiMKIyAyLiBJbnNwZWN0OgojICAgIGxlc3MgZnVja2l0LnNoCiMKIyAzLiBSdW4gKEluc3RhbGwpOgojICAgIGJhc2ggZnVja2l0LnNoCiMKIyA0LiBSdW4gKFRlbXBvcmFyeSk6CiMgICAgYmFzaCBmdWNraXQuc2ggInlvdXIgcHJvbXB0IgojCgpzZXQgLWV1byBwaXBlZmFpbAoKIyAtLS0gQ29sb3IgRGVmaW5pdGlvbnMgLS0tCnJlYWRvbmx5IENfUkVTRVQ9J1wwMzNbMG0nCnJlYWRvbmx5IENfUkVEX0JPTEQ9J1wwMzNbMTszMW0nCnJlYWRvbmx5IENfUkVEPSdcMDMzWzA7MzFtJwpyZWFkb25seSBDX0dSRUVOPSdcMDMzWzA7MzJtJwpyZWFkb25seSBDX1lFTExPVz0nXDAzM1swOzMzbScKcmVhZG9ubHkgQ19DWUFOPSdcMDMzWzA7MzZtJwpyZWFkb25seSBDX0JPTEQ9J1wwMzNbMW0nCgojIC0tLSBGVUNLISAtLS0KcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfUZVQ0shJHtDX1JFU0VUfSIKcmVhZG9ubHkgRkNLTj0iJHtDX1JFRH1GKkNLSU5HJHtDX1JFU0VUfSIKCgojIC0tLSBDb25maWd1cmF0aW9uIC0tLQpyZWFkb25seSBJTlNUQUxMX0RJUj0iJEhPTUUvLmZ1Y2siCnJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgojIFRoZSBBUEkgZW5kcG9pbnQgZm9yIHRoZSBDbG91ZGZsYXJlIEVkZ2UgRnVuY3Rpb24KcmVhZG9ubHkgQVBJX0VORFBPSU5UPSJodHRwczovL2Z1Y2tpdC5zaC8iCgoKIyAtLS0gQ29yZSBMb2dpYyAoRW1iZWRkZWQgYXMgYSBzdHJpbmcpIC0tLQpDT1JFX0xPR0lDPSQoY2F0IDw8J0VPRicKCiMgLS0tIEJlZ2luIENvcmUgTG9naWMgZm9yIGZ1Y2tpdC5zaCAtLS0KCiMgLS0tIENvbG9yIERlZmluaXRpb25zIC0tLQojIE9ubHkgZGVmaW5lIGNvbG9ycyBpZiB0aGV5IGhhdmVuJ3QgYmVlbiBkZWZpbmVkIHlldCAoZm9yIHRlbXAgbW9kZSkKaWYgWyAteiAiJHtDX1JFU0VUOi19IiBdOyB0aGVuCiAgICByZWFkb25seSBDX1JFU0VUPSdcMDMzWzBtJwogICAgcmVhZG9ubHkgQ19SRURfQk9MRD0nXDAzM1sxOzMxbScKICAgIHJlYWRvbmx5IENfUkVEPSdcMDMzWzA7MzFtJwogICAgcmVhZG9ubHkgQ19HUkVFTj0nXDAzM1swOzMybScKICAgIHJlYWRvbmx5IENfWUVMTE9XPSdcMDMzWzA7MzNtJwogICAgcmVhZG9ubHkgQ19DWUFOPSdcMDMzWzA7MzZtJwogICAgcmVhZG9ubHkgQ19CT0xEPSdcMDMzWzFtJwoKICAgICMgLS0tIEZVQ0shIC0tLQogICAgcmVhZG9ubHkgRlVDSz0iJHtDX1JFRF9CT0xEfUZVQ0shJHtDX1JFU0VUfSIKICAgIHJlYWRvbmx5IEZDS049IiR7Q19SRUR9RipDS0lORyR7Q19SRVNFVH0iCgogICAgIyAtLS0gQ29uZmlndXJhdGlvbiAtLS0KICAgIHJlYWRvbmx5IElOU1RBTExfRElSPSIkSE9NRS8uZnVjayIKICAgIHJlYWRvbmx5IE1BSU5fU0g9IiRJTlNUQUxMX0RJUi9tYWluLnNoIgpmaQoKIyBIZWxwZXIgdG8gZmluZCB0aGUgdXNlcidzIHNoZWxsIHByb2ZpbGUgZmlsZQpfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgZm9yIHNoLCBrc2gsIGV0Yy4KICAgICAgICBlY2hvICIkSE9NRS8ucHJvZmlsZSIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnpzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsc2UKICAgICAgICBlY2hvICJ1bmtub3duX3Byb2ZpbGUiCiAgICBmaQp9CgojIERldGVjdHMgdGhlIHBhY2thZ2UgbWFuYWdlcgpfZnVja19kZXRlY3RfcGtnX21hbmFnZXIoKSB7CiAgICBpZiBjb21tYW5kIC12IGFwdC1nZXQgJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAiYXB0IgogICAgZWxpZiBjb21tYW5kIC12IHl1bSAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJ5dW0iCiAgICBlbGlmIGNvbW1hbmQgLXYgZG5mICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gImRuZiIKICAgIGVsaWYgY29tbWFuZCAtdiBwYWNtYW4gJj4gL2Rldi9udWxsOyB0aGVuCiAgICAgICAgZWNobyAicGFjbWFuIgogICAgZWxpZiBjb21tYW5kIC12IHp5cHBlciAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJ6eXBwZXIiCiAgICBlbGlmIGNvbW1hbmQgLXYgYnJldyAmPiAvZGV2L251bGw7IHRoZW4KICAgICAgICBlY2hvICJicmV3IgogICAgZWxzZQogICAgICAgIGVjaG8gInVua25vd24iCiAgICBmaQp9CgojIENvbGxlY3RzIHN5c3RlbSBpbmZvIGFzIGEgc2ltcGxlIHN0cmluZwpfZnVja19jb2xsZWN0X3N5c2luZm9fc3RyaW5nKCkgewogICAgbG9jYWwgcGtnX21hbmFnZXIKICAgIHBrZ19tYW5hZ2VyPSQoX2Z1Y2tfZGV0ZWN0X3BrZ19tYW5hZ2VyKQogICAgIyBUaGUgc2VydmVyLXNpZGUgTExNIHByb21wdCB3aWxsIG5lZWQgdG8gcGFyc2UgdGhpcyBzdHJpbmcKICAgIGVjaG8gIk9TOiAkKHVuYW1lIC1zKSwgQXJjaDogJCh1bmFtZSAtbSksIFNoZWxsOiAke1NIRUxMOi11bmtub3dufSwgUGtnTWdyOiAkcGtnX21hbmFnZXIsIENXRDogJChwd2QpIgp9CgojIEVzY2FwZXMgYSBzdHJpbmcgZm9yIHVzZSBpbiBhIEpTT04gcGF5bG9hZApfZnVja19qc29uX2VzY2FwZSgpIHsKICAgICMgQmFzaWMgZXNjYXBlIGZvciBxdW90ZXMsIGJhY2tzbGFzaGVzLCBhbmQgY29udHJvbCBjaGFyYWN0ZXJzCiAgICBwcmludGYgJyVzJyAiJDEiIHwgc2VkIC1lICdzL1xcL1xcXFwvZycgLWUgJ3MvIi9cXCIvZycgLWUgJ3MvXG4vXFxuL2cnIC1lICdzL1xyL1xcci9nJyAtZSAncy9cdC9cXHQvZycKfQoKIyBVbmluc3RhbGxzIHRoZSBzY3JpcHQKX3VuaW5zdGFsbF9zY3JpcHQoKSB7CiAgICBlY2hvIC1lICIkRlVDSyAke0NfWUVMTE9XfVNvIHlvdSdyZSBraWNraW5nIG1lIG91dD8gRmluZS4ke0NfUkVTRVR9IgoKICAgICMgRmluZCB0aGUgcHJvZmlsZSBmaWxlCiAgICBsb2NhbCBwcm9maWxlX2ZpbGUKICAgIHByb2ZpbGVfZmlsZT0kKF9pbnN0YWxsZXJfZGV0ZWN0X3Byb2ZpbGUpCiAgICBsb2NhbCBzb3VyY2VfbGluZT0ic291cmNlICRNQUlOX1NIIgoKICAgIGlmIFsgIiRwcm9maWxlX2ZpbGUiICE9ICJ1bmtub3duX3Byb2ZpbGUiIF0gJiYgWyAtZiAiJHByb2ZpbGVfZmlsZSIgXTsgdGhlbgogICAgICAgIGlmIGdyZXAgLXFGICIkc291cmNlX2xpbmUiICIkcHJvZmlsZV9maWxlIjsgdGhlbgogICAgICAgICAgICAjIFVzZSBzZWQgdG8gcmVtb3ZlIHRoZSBsaW5lcy4gQ3JlYXRlIGEgYmFja3VwLgogICAgICAgICAgICBzZWQgLWkuYmFrICJcfCRzb3VyY2VfbGluZXxkIiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICAgICAgc2VkIC1pLmJhayAiXHwjIEFkZGVkIGJ5IGZ1Y2tpdC5zaCBpbnN0YWxsZXJ8ZCIgIiRwcm9maWxlX2ZpbGUiCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBlY2hvIC1lICIke0NfWUVMTE9XfUNvdWxkIG5vdCBmaW5kIGEgc2hlbGwgcHJvZmlsZSBmaWxlIHRvIG1vZGlmeS4gWW91ciBwcm9ibGVtIG5vdy4ke0NfUkVTRVR9IgogICAgZmkKCiAgICBpZiBbIC1kICIkSU5TVEFMTF9ESVIiIF07IHRoZW4KICAgICAgICBybSAtcmYgIiRJTlNUQUxMX0RJUiIKICAgIGZpCgogICAgZWNobyAtZSAiJEZVQ0sgJHtDX0dSRUVOfUknbSBnb25lLiBEb24ndCBjb21lIGNyeWluZyBiYWNrLiR7Q19SRVNFVH0iCiAgICBlY2hvIC1lICIke0NfQ1lBTn1Ob3cgcmVzdGFydCB5b3VyIGRhbW4gc2hlbGwuJHtDX1JFU0VUfSIKfQoKIyBUaGUgbWFpbiBmdW5jdGlvbiB0aGF0IGNvbnRhY3RzIHRoZSBBUEkKIyBUYWtlcyA+MCBhcmd1bWVudHMgYXMgdGhlIHByb21wdApfZnVja19leGVjdXRlX3Byb21wdCgpIHsKICAgICMgSWYgdGhlIHVzZXIgdHlwZXMgKm9ubHkqICJmdWNrIHVuaW5zdGFsbCIKICAgIGlmIFsgIiQxIiA9ICJ1bmluc3RhbGwiIF0gJiYgWyAiJCMiIC1lcSAxIF07IHRoZW4KICAgICAgICBfdW5pbnN0YWxsX3NjcmlwdAogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIGlmICEgY29tbWFuZCAtdiBjdXJsICY+IC9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9J2Z1Y2snIGNvbW1hbmQgbmVlZHMgJ2N1cmwnLiBQbGVhc2UgaW5zdGFsbCBpdC4ke0NfUkVTRVR9IiA+JjIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBpZiBbICIkIyIgLWVxIDAgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9WW91IGZvcmdvdCB0byBhc2sgbWUgd2hhdCB0byBkby4ke0NfUkVTRVR9IiA+JjIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBsb2NhbCBwcm9tcHQ9IiQqIgogICAgbG9jYWwgc3lzaW5mb19zdHJpbmcKICAgIHN5c2luZm9fc3RyaW5nPSQoX2Z1Y2tfY29sbGVjdF9zeXNpbmZvX3N0cmluZykKICAgIAogICAgbG9jYWwgZXNjYXBlZF9wcm9tcHQKICAgIGVzY2FwZWRfcHJvbXB0PSQoX2Z1Y2tfanNvbl9lc2NhcGUgIiRwcm9tcHQiKQogICAgCiAgICBsb2NhbCBlc2NhcGVkX3N5c2luZm8KICAgIGVzY2FwZWRfc3lzaW5mbz0kKF9mdWNrX2pzb25fZXNjYXBlICIkc3lzaW5mb19zdHJpbmciKQoKICAgICMgQ29uc3RydWN0IHRoZSBKU09OIHBheWxvYWQKICAgIGxvY2FsIHBheWxvYWQKICAgIHBheWxvYWQ9JChwcmludGYgJ3sgInN5c2luZm8iOiAiJXMiLCAicHJvbXB0IjogIiVzIiB9JyAiJGVzY2FwZWRfc3lzaW5mbyIgIiRlc2NhcGVkX3Byb21wdCIpCgogICAgIyBBUElfRU5EUE9JTlQgbXVzdCBiZSBoYXJkY29kZWQgaGVyZSBmb3IgdGhlIGxvZ2ljIHRvIGJlIHBvcnRhYmxlCiAgICBsb2NhbCBhcGlfdXJsPSJodHRwczovL2Z1Y2tpdC5zaC8iCgogICAgbG9jYWwgcmVzcG9uc2UKICAgIHJlc3BvbnNlPSQoY3VybCAtcyAtWCBQT1NUICIkYXBpX3VybCIgXAogICAgICAgIC1IICJDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb24iIFwKICAgICAgICAtZCAiJHBheWxvYWQiKQoKICAgIGlmIFsgLXogIiRyZXNwb25zZSIgXTsgdGhlbgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19SRUR9VGhlIEFJIGlzIGdob3N0aW5nIG1lLiBHb3Qgbm90aGluZyBiYWNrLiR7Q19SRVNFVH0iID4mMgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgICMgLS0tIFVzZXIgQ29uZmlybWF0aW9uIChhcyByZXF1ZXN0ZWQpIC0tLQogICAgZWNobyAtZSAiJHtDX1lFTExPV30tLS0gVGhlIEFJIG11bWJsZWQgdGhpcywgaG9wZSBpdCdzIHJpZ2h0IC0tLSR7Q19SRVNFVH0iCiAgICAjIERpcmVjdCBvdXRwdXQsIG5vICdtb3JlJwogICAgZWNobyAtZSAiJHtDX0NZQU59JHJlc3BvbnNlJHtDX1JFU0VUfSIKICAgIGVjaG8gLWUgIiR7Q19ZRUxMT1d9LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJHtDX1JFU0VUfSIKICAgIAogICAgIyBTZWNvbmRhcnkgY29uZmlybWF0aW9uIHByb21wdAogICAgcHJpbnRmICIkRkNLTiAke0NfQk9MRH0ke0NfWUVMTE9XfWV4ZWN1dGUgaXQ/IFt5L05dJHtDX1JFU0VUfSAiCiAgICBsb2NhbCBjb25maXJtYXRpb24KICAgIHJlYWQgLXIgY29uZmlybWF0aW9uCgogICAgaWYgW1sgIiRjb25maXJtYXRpb24iID1+IF5beVldKFtlRV1bc1NdKT8kIF1dOyB0aGVuCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRF9CT0xEfUlULCR7Q19DWUFOfSBXRSBETyBJVCBMSVZFISR7Q19SRVNFVH0iID4mMgogICAgICAgICMgRXhlY3V0ZSB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyCiAgICAgICAgZXZhbCAiJHJlc3BvbnNlIgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19HUkVFTn1JdCdzIGRvbmUuIFByb2JhYmx5LiR7Q19SRVNFVH0iCiAgICBlbHNlCiAgICAgICAgZWNobyAtZSAiJEZVQ0sgJHtDX1JFRH1GaW5lLCBkbyBpdCB5b3Vyc2VsZi4ke0NfUkVTRVR9IiA+JjIKICAgIGZpCn0KCiMgRGVmaW5lIHRoZSBhbGlhcyBmb3IgaW50ZXJhY3RpdmUgdXNlCmFsaWFzIGZ1Y2s9J19mdWNrX2V4ZWN1dGVfcHJvbXB0JwoKIyAtLS0gRW5kIENvcmUgTG9naWMgLS0tCkVPRgopCiMgLS0tIEVuZCBvZiBDb3JlIExvZ2ljIEhlcmVkb2MgLS0tCgoKIyAtLS0gSW5zdGFsbGVyIEZ1bmN0aW9ucyAoUnVuIGJ5IHRoZSBvdXRlciBzY3JpcHQpIC0tLQoKIyBIZWxwZXIgdG8gZmluZCB0aGUgdXNlcidzIHNoZWxsIHByb2ZpbGUgZmlsZQpfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKCkgewogICAgaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAienNoIjsgdGhlbgogICAgICAgIGVjaG8gIiRIT01FLy56c2hyYyIKICAgIGVsaWYgWyAtbiAiJHtTSEVMTDotfSIgXSAmJiBlY2hvICIkU0hFTEwiIHwgZ3JlcCAtcSAiYmFzaCI7IHRoZW4KICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8ucHJvZmlsZSIgXTsgdGhlbgogICAgICAgICMgRmFsbGJhY2sgZm9yIHNoLCBrc2gsIGV0Yy4KICAgICAgICBlY2hvICIkSE9NRS8ucHJvZmlsZSIKICAgIGVsaWYgWyAtZiAiJEhPTUUvLnpzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLnpzaHJjIgogICAgZWxpZiBbIC1mICIkSE9NRS8uYmFzaHJjIiBdOyB0aGVuCiAgICAgICAgIyBGYWxsYmFjayBpZiBTSEVMTCB2YXIgaXNuJ3Qgc2V0CiAgICAgICAgZWNobyAiJEhPTUUvLmJhc2hyYyIKICAgIGVsc2UKICAgICAgICBlY2hvICJ1bmtub3duX3Byb2ZpbGUiCiAgICBmaQp9CgojIE1haW4gaW5zdGFsbGF0aW9uIGZ1bmN0aW9uCl9pbnN0YWxsX3NjcmlwdCgpIHsKICAgIGVjaG8gLWUgIiRGQ0tOICR7Q19CT0xEfUFscmlnaHQsIGxldCdzIGdldCB0aGlzIHNoaXQgaW5zdGFsbGVkLi4uJHtDX1JFU0VUfSIKICAgIG1rZGlyIC1wICIkSU5TVEFMTF9ESVIiCiAgICAKICAgICMgV3JpdGUgdGhlIGVtYmVkZGVkIGNvcmUgbG9naWMgdG8gdGhlIG1haW4uc2ggZmlsZQogICAgZWNobyAiJENPUkVfTE9HSUMiID4gIiRNQUlOX1NIIgogICAgCiAgICBpZiBbICQ/IC1uZSAwIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfUNhbid0IHdyaXRlIHRvIHRoZSBmaWxlLiBDaGVjayB5b3VyIGRhbW4gcGVybWlzc2lvbnMuJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgIyBBZGQgc291cmNlIGxpbmUgdG8gc2hlbGwgcHJvZmlsZQogICAgbG9jYWwgcHJvZmlsZV9maWxlCiAgICBwcm9maWxlX2ZpbGU9JChfaW5zdGFsbGVyX2RldGVjdF9wcm9maWxlKQogICAgCiAgICBpZiBbICIkcHJvZmlsZV9maWxlIiA9ICJ1bmtub3duX3Byb2ZpbGUiIF07IHRoZW4KICAgICAgICBlY2hvIC1lICIkRlVDSyAke0NfUkVEfUkgY2FuJ3QgZmluZCAuYmFzaHJjLCAuenNocmMsIG9yIC5wcm9maWxlLiBZb3UncmUgb24geW91ciBvd24uJHtDX1JFU0VUfSIgPiYyCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31NYW51YWxseSBhZGQgdGhpcyBsaW5lIHRvIHdoYXRldmVyIHN0YXJ0dXAgZmlsZSB5b3UgdXNlOiR7Q19SRVNFVH0iID4mMgogICAgICAgIGVjaG8gLWUgIlxuICAke0NfQ1lBTn1zb3VyY2UgJE1BSU5fU0gke0NfUkVTRVR9XG4iID4mMgogICAgICAgIHJldHVybgogICAgZmkKICAgIAogICAgbG9jYWwgc291cmNlX2xpbmU9InNvdXJjZSAkTUFJTl9TSCIKICAgIGlmICEgZ3JlcCAtcUYgIiRzb3VyY2VfbGluZSIgIiRwcm9maWxlX2ZpbGUiOyB0aGVuCiAgICAgICAgIyBFbnN1cmUgdGhlIGZpbGUgZW5kcyB3aXRoIGEgbmV3bGluZSBiZWZvcmUgd2UgYWRkIG91ciBsaW5lcwogICAgICAgIGlmIFsgLW4gIiQodGFpbCAtYzEgIiRwcm9maWxlX2ZpbGUiKSIgXTsgdGhlbgogICAgICAgICAgICBlY2hvICIiID4+ICIkcHJvZmlsZV9maWxlIgogICAgICAgIGZpCiAgICAgICAgZWNobyAiIyBBZGRlZCBieSBmdWNraXQuc2ggaW5zdGFsbGVyIiA+PiAiJHByb2ZpbGVfZmlsZSIKICAgICAgICBlY2hvICIkc291cmNlX2xpbmUiID4+ICIkcHJvZmlsZV9maWxlIgogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19HUkVFTn1JdCdzIGluc3RhbGxlZC4gTm93IGdldCB0byB3b3JrLiR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiJHtDX1lFTExPV31SZXN0YXJ0IHlvdXIgc2hlbGwsIG9yIHJ1biAke0NfQk9MRH1zb3VyY2UgJHByb2ZpbGVfZmlsZSR7Q19ZRUxMT1d9IHRvIHN0YXJ0LiR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiXG4ke0NfQk9MRH0tLS0gSE9XIFRPIFVTRSAtLS0ke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIkp1c3QgdHlwZSAke0NfUkVEX0JPTER9ZnVjayR7Q19SRVNFVH0gZm9sbG93ZWQgYnkgd2hhdCB5b3Ugd2FudCB0byBkby4iCiAgICAgICAgZWNobyAtZSAiRXhhbXBsZXM6IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX0NZQU59ZnVjayBpbnN0YWxsIGdpdCR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiICAke0NfQ1lBTn1mdWNrIHVuaW5zdGFsbCBnaXQke0NfUkVTRVR9IgogICAgICAgIGVjaG8gLWUgIiAgJHtDX0NZQU59ZnVjayBmaW5kIGFsbCBmaWxlcyBsYXJnZXIgdGhhbiAxME1CIGluIHRoZSBjdXJyZW50IGRpcmVjdG9yeSR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiICAke0NfUkVEX0JPTER9ZnVjayB1bmluc3RhbGwke0NfUkVTRVR9ICR7Q19HUkVFTn0jIFVuaW5zdGFsbHMgJHtDX1JFU0VUfSR7Q19SRUR9ZnVjayR7Q19SRVNFVH0ke0NfR1JFRU59IGl0c2VsZiR7Q19SRVNFVH0iCiAgICAgICAgZWNobyAtZSAiXG4ke0NfWUVMTE9XfVJlbWVtYmVyIHRvIHJlc3RhcnQgeW91ciBzaGVsbCB0byBiZWdpbiEke0NfUkVTRVR9IgogICAgZWxzZQogICAgICAgIGVjaG8gLWUgIiRGVUNLICR7Q19ZRUxMT1d9SXQncyBhbHJlYWR5IGluc3RhbGxlZCwgZ2VuaXVzLiBKdXN0IHVwZGF0ZWQgdGhlIHNjcmlwdCBmb3IgeW91LiR7Q19SRVNFVH0iCiAgICBmaQp9CgoKIyAtLS0gTWFpbiBTY3JpcHQgRW50cnlwb2ludCAtLS0KCiMgSWYgYXJndW1lbnRzIGFyZSBwYXNzZWQgKGUuZy4sICJiYXNoIC1zIC4uLiIpCmlmIFsgIiQjIiAtZ3QgMCBdOyB0aGVuCiAgICAjIFRlbXBvcmFyeSBNb2RlCiAgICAjIEV2YWx1YXRlIHRoZSBjb3JlIGxvZ2ljIHRvIGRlZmluZSBmdW5jdGlvbnMgaW4gdGhpcyBzaGVsbAogICAgZXZhbCAiJENPUkVfTE9HSUMiCiAgICAjIENhbGwgdGhlIG1haW4gZnVuY3Rpb24gZGlyZWN0bHkgKGFsaWFzIHdvbid0IHdvcmsgaGVyZSkKICAgIF9mdWNrX2V4ZWN1dGVfcHJvbXB0ICIkQCIKZWxzZQogICAgIyBJbnN0YWxsIE1vZGUKICAgIF9pbnN0YWxsX3NjcmlwdApmaQo=`);

export default {
  async fetch(request, env, ctx) {
    if (request.method === 'GET') {
      return handleGetRequest(request);
    } else if (request.method === 'POST') {
      return handlePostRequest(request, env);
    } else {
      return new Response('Expected GET or POST', { status: 405 });
    }
  },
};

/**
 * Handles GET requests to serve the installer script.
 * @param {Request} request The incoming request.
 * @returns {Response} A response with the shell script.
 */
function handleGetRequest(request) {
  return new Response(INSTALLER_SCRIPT, {
    headers: {
      'Content-Type': 'text/plain; charset=utf-8',
      'Content-Disposition': 'attachment; filename="fuckit.sh"',
    },
  });
}

/**
 * Handles POST requests by forwarding the prompt to an AI model.
 * @param {Request} request The incoming request.
 * @param {object} env The environment variables.
 * @returns {Promise<Response>} A promise that resolves to the AI's response.
 */
async function handlePostRequest(request, env) {
  try {
    const { sysinfo, prompt } = await request.json();

    if (!prompt) {
      return new Response('Missing "prompt" in request body', { status: 400 });
    }
    if (!env.OPENAI_API_KEY) {
      return new Response('Missing OPENAI_API_KEY secret', { status: 500 });
    }

    const model = env.OPENAI_API_MODEL || 'gpt-4-turbo';
    const apiBase = (env.OPENAI_API_BASE || 'https://api.openai.com/v1').replace(/\/$/, '');
    const apiUrl = `${apiBase}/chat/completions`;

    const aiRequestPayload = {
      model: model,
      messages: [
        {
          role: 'system',
          content: `You are an expert shell script generator. A user will provide their system information and a prompt. Your task is to return a raw, executable shell script that accomplishes their goal. The script can be multi-line. Do not provide any explanation, comments, markdown formatting (like \`\`\`bash), or a shebang (e.g., #!/bin/bash). Just the raw script content. The user's system info is: ${sysinfo}`,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 1024,
      temperature: 0.2,
    };

    const aiResponse = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify(aiRequestPayload),
    });

    if (!aiResponse.ok) {
      const errorText = await aiResponse.text();
      return new Response(`AI API Error: ${errorText}`, { status: aiResponse.status });
    }

    const aiJson = await aiResponse.json();
    const command = aiJson.choices[0]?.message?.content.trim();

    if (!command) {
      return new Response('The AI returned an empty command.', { status: 500 });
    }

    return new Response(command, {
      headers: { 'Content-Type': 'text/plain' },
    });
  } catch (error) {
    return new Response(`Error: ${error.message}`, { status: 500 });
  }
}
