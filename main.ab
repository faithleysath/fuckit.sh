const VERSION = "0.1.0"
const LANG = "en"
const NAME = "fuck"
// const URL = "https://fuckit.sh"
const URL = "http://host.docker.internal:5500/main.sh"

const USAGE = "

"
// Dependency Checks
// check bc
$ command -v bc > /dev/null 2>&1 $ failed {
    trust $ echo -e "\\033[0;31mDependency check failed: 'bc' command not found. Please install 'bc' and try again.\\033[0m" >&2 $
    trust $ echo "  - Debian/Ubuntu: sudo apt-get install bc" >&2 $
    trust $ echo "  - RedHat/CentOS: sudo yum install bc" >&2 $
    trust $ echo "  - Fedora:        sudo dnf install bc" >&2 $
    trust $ echo "  - Arch Linux:    sudo pacman -S bc" >&2 $
    trust $ echo "  - openSUSE:      sudo zypper install bc" >&2 $
    trust $ echo "  - Alpine:        apk add bc" >&2 $
    exit 1
}

// check curl
$ command -v curl > /dev/null 2>&1 $ failed {
    trust $ echo -e "\\033[0;31mDependency check failed: 'curl' command not found. Please install 'curl' and try again.\\033[0m" >&2 $
    trust $ echo "  - Debian/Ubuntu: sudo apt-get install curl" >&2 $
    trust $ echo "  - RedHat/CentOS: sudo yum install curl" >&2 $
    trust $ echo "  - Fedora:        sudo dnf install curl" >&2 $
    trust $ echo "  - Arch Linux:    sudo pacman -S curl" >&2 $
    trust $ echo "  - openSUSE:      sudo zypper install curl" >&2 $
    trust $ echo "  - Alpine:        apk add curl" >&2 $
    trust $ echo "  - MacOS (Homebrew): brew install curl" >&2 $
    exit 1
}

import { env_var_get, echo_error, echo_warning, echo_info, echo_success, env_var_set } from "std/env"
import { starts_with, split, parse_number } from "std/text"
import { array_contains } from "std/array"
import { request_llm} from "./utils/llm.ab"
import { install, uninstall } from "./core/installer.ab"
import { start_chat_session } from "./core/chat.ab"

// Get the home directory from environment variable
let home_dir = trust env_var_get("HOME")
if home_dir == "" :
    echo_warning("HOME environment variable is not set. Try 'export HOME=~' and run again. Add to your shell profile to make it permanent.")

main (arguments) {
    // Handle zero arguments case (although this should not happen)
    if len(arguments) < 1 :
        echo_error("Oops, no arguments provided! It should not happen. But it did. Please visit https://fuckit.sh and report this issue.")
    // First argument is the script name
    let script_name = arguments[0]
    // Set persona based on the script name, and export it for other modules to use.
    let persona = trust $ basename "{script_name}" $
    trust env_var_set("FUCKIT_PERSONA", persona)
    // Remaining arguments are passed to the script
    let script_args = arguments[1..len(arguments)]

    // Check execution mode
    if {
        // Print Version (Highest Priority)
        len(script_args) == 1 and array_contains(["-v", "--version", "version"], script_args[0]):
            echo VERSION

        // Uninstall
        len(script_args) == 1 and script_args[0] == "uninstall" :
            uninstall(home_dir, NAME)

        // Install / Upgrade
        len(script_args) == 0 and not starts_with(script_name, home_dir + "/.local/bin"):
            install(home_dir, NAME, VERSION, URL)

        // Usage
        len(script_args) == 0 and starts_with(script_name, home_dir + "/.local/bin"):
            echo "hi"

        // Default case: Normal execution
        else {
            start_chat_session(script_args)
        }
    }
}
