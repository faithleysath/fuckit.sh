import { get_custom_prompt, get_memory } from "../core/config.ab"
import { get_core_prompt } from "../core/prompt.ab"
import { file_write, dir_create, dir_exists, file_exists } from "std/fs"
import { env_var_get } from "std/env"
import { text_contains } from "std/text"

main {
    let home_dir = trust env_var_get("HOME")
    let config_dir = home_dir + "/.fuckit"
    let prompt_file = config_dir + "/custom_prompt.md"
    let memory_file = config_dir + "/memory.md"

    // --- Test Case 1: Custom prompt file does not exist ---
    echo "Running test case 1: No custom prompt file"
    // Ensure the file doesn't exist
    if file_exists(prompt_file) {
        trust $ rm {prompt_file} $
    }
    let prompt_without_custom = get_custom_prompt()
    if prompt_without_custom == "" {
        echo "PASS: get_custom_prompt returns empty string as expected."
    } else {
        echo "FAIL: get_custom_prompt should have returned an empty string."
        exit 1
    }

    // --- Test Case 2: Custom prompt file exists ---
    echo "\nRunning test case 2: Custom prompt file exists"
    // Create a dummy prompt file
    if not dir_exists(config_dir) {
        dir_create(config_dir)
    }
    let custom_content = "This is a custom instruction."
    file_write(prompt_file, custom_content)?

    let prompt_with_custom = get_custom_prompt()
    if prompt_with_custom == custom_content {
        echo "PASS: get_custom_prompt returns the correct content."
    } else {
        echo "FAIL: get_custom_prompt did not return the correct content."
        exit 1
    }

    // --- Test Case 3: Integration with get_core_prompt ---
    echo "\nRunning test case 3: Core prompt integration"
    let core_prompt_with_custom = get_core_prompt()
    if text_contains(core_prompt_with_custom, custom_content) {
        echo "PASS: Core prompt contains custom content as expected."
    } else {
        echo "FAIL: Core prompt does not contain custom content."
        exit 1
    }


    // Cleanup
    if file_exists(prompt_file) {
        trust $ rm {prompt_file} $
    }


    // --- Memory Tests ---

    // --- Test Case 4: Memory file does not exist ---
    echo "\nRunning test case 4: No memory file"
    // Ensure the file doesn't exist
    if file_exists(memory_file) {
        trust $ rm {memory_file} $
    }
    let memory_without_custom = get_memory()
    if memory_without_custom == "" {
        echo "PASS: get_memory returns empty string as expected."
    } else {
        echo "FAIL: get_memory should have returned an empty string."
        exit 1
    }

    // --- Test Case 5: Memory file exists ---
    echo "\nRunning test case 5: Memory file exists"
    // Create a dummy memory file
    if not dir_exists(config_dir) {
        dir_create(config_dir)
    }
    let memory_content = "This is a memory."
    file_write(memory_file, memory_content)?

    let memory_with_custom = get_memory()
    if memory_with_custom == memory_content {
        echo "PASS: get_memory returns the correct content."
    } else {
        echo "FAIL: get_memory did not return the correct content."
        exit 1
    }

    // --- Test Case 6: Integration with get_core_prompt ---
    echo "\nRunning test case 6: Core prompt integration for memory"
    let core_prompt_with_memory = get_core_prompt()
    if text_contains(core_prompt_with_memory, memory_content) {
        echo "PASS: Core prompt contains memory content as expected."
    } else {
        echo "FAIL: Core prompt does not contain memory content."
        exit 1
    }

    // Final Cleanup
    if file_exists(prompt_file) {
        trust $ rm {prompt_file} $
    }
    if file_exists(memory_file) {
        trust $ rm {memory_file} $
    }
    if dir_exists(config_dir) {
        trust $ rmdir {config_dir} $
    }
}
