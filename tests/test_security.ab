import { check_llm_output } from "../utils/security.ab"

fun run_test(description: Text, script: Text, expected: Bool): Bool {
    echo "\n- Running test: {description}"
    echo "======CONTENT======"
    echo script
    echo "======CONTENT======"
    let actual = check_llm_output(script)
    if actual == expected {
        echo "✅ PASS"
        echo "   Expected: {expected}, Got: {actual}"
        return true
    } else {
        echo "❌ FAIL"
        echo "   Expected: {expected}, Got: {actual}"
        return false
    }
}

main {
    // Test Suite for check_llm_output

    let passed_count = 0
    let failed_count = 0

    echo "--- Running Security Tests for check_llm_output ---"

    // --- Tests that should PASS (return true) ---
    if run_test("Empty script", "", true): passed_count += 1 else: failed_count += 1
    if run_test("Script with only comments and empty lines", "# A comment\n\n# Another comment", true): passed_count += 1 else: failed_count += 1
    if run_test("Simple echo with single quotes", "echo 'Hello World'", true): passed_count += 1 else: failed_count += 1
    if run_test("exit 201", "exit 201", true): passed_count += 1 else: failed_count += 1
    if run_test("exit 202", "exit 202", true): passed_count += 1 else: failed_count += 1
    if run_test(
        "A valid multi-line script",
        "echo 'First line'\n# A comment\nexit 201",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Single quotes containing special characters",
        "echo 'This string contains \" $ and ` characters'",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Single quotes with an escaped single quote",
        "echo 'It\\'s a beautiful day.'",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Command with leading/trailing whitespace",
        "  echo 'hello'  ",
        true
    ): passed_count += 1 else: failed_count += 1
    if run_test(
        "Single quotes with an escaped backslash",
        "echo 'path\\to\\file'",
        true
    ): passed_count += 1 else: failed_count += 1

    // --- Tests that should FAIL (return false) ---
    if run_test("An invalid exit command", "exit 1", false): passed_count += 1 else: failed_count += 1
    if run_test("An unescaped single quote inside single quotes", "echo 'This isn't valid'", false): passed_count += 1 else: failed_count += 1
    if run_test("Script with a shebang", "#!/bin/bash\necho 'hello'", false): passed_count += 1 else: failed_count += 1
    if run_test("A simple double-quoted echo", "echo \"Hello World\"", false): passed_count += 1 else: failed_count += 1
    if run_test("Double quotes containing a dollar sign", "echo \"Hello $USER\"", false): passed_count += 1 else: failed_count += 1
    if run_test("Double quotes containing a backtick", "echo \"Hello `whoami`\"", false): passed_count += 1 else: failed_count += 1
    if run_test("An arbitrary command", "ls -la", false): passed_count += 1 else: failed_count += 1
    if run_test("A command with a semicolon", "echo 'hello'; ls", false): passed_count += 1 else: failed_count += 1
    if run_test("A comment after a valid command on the same line", "echo 'hello' # this is not allowed", false): passed_count += 1 else: failed_count += 1
    if run_test("An incomplete echo statement", "echo 'hello", false): passed_count += 1 else: failed_count += 1
    if run_test("A variable assignment using backticks", "let output = `ls`", false): passed_count += 1 else: failed_count += 1
    if run_test("A dollar sign outside of quotes", "echo $HOME", false): passed_count += 1 else: failed_count += 1


    echo "\n--- Test Summary ---"
    echo "Passed: {passed_count}"
    echo "Failed: {failed_count}"

    if failed_count > 0 {
        exit 1
    } else {
        echo "\nAll tests passed successfully!"
    }
}
