import * from "../utils/json.ab"
import { is_command } from "std/env"

main {
    let saying = "He said: \"Hi\"\nNew line with\\ a backslash"
    let expected_escape = "\"He said: \\\"Hi\\\"\\nNew line with\\\\ a backslash\""
    let json_str = "\{\"says\": {expected_escape}, \"nested\": \{\"a\": [1, 2]}}"

    echo "--- Testing Individual Functions ---"

    // Test jq escape
    if is_command("jq") {
        let escaped_jq = trust safe_escape_json_jq(saying)
        if escaped_jq != expected_escape {
            echo "Error: safe_escape_json_jq failed!"
            exit 1
        }
        echo "safe_escape_json_jq: PASSED"
    } else {
        echo "safe_escape_json_jq: SKIPPED (jq not found)"
    }

    // Test python escape
    let escaped_py = trust safe_escape_json_py(saying)
    if escaped_py != expected_escape {
        echo "Error: safe_escape_json_py failed!"
        exit 1
    }
    echo "safe_escape_json_py: PASSED"

    // Test fallback escape
    let escaped_fallback = safe_escape_json_fallback(saying)
    if escaped_fallback != expected_escape {
        echo "Error: safe_escape_json_fallback failed!"
        exit 1
    }
    echo "safe_escape_json_fallback: PASSED"

    // Test jq extract
    if is_command("jq") {
        let extracted_jq = trust extract_json_value_jq(json_str, "says")
        if extracted_jq != saying {
            echo "Error: extract_json_value_jq (says) failed!"
            exit 1
        }
        let extracted_nested_jq = trust extract_json_value_jq(json_str, "nested.a.1")
        if extracted_nested_jq != "2" {
            echo "Error: extract_json_value_jq (nested) failed!"
            exit 1
        }
        echo "extract_json_value_jq: PASSED"
    } else {
        echo "extract_json_value_jq: SKIPPED (jq not found)"
    }

    // Test python extract
    let extracted_py = trust extract_json_value_py(json_str, "says")
    if extracted_py != saying {
        echo "Error: extract_json_value_py (says) failed!"
        exit 1
    }
    let extracted_nested_py = trust extract_json_value_py(json_str, "nested.a.1")
    if extracted_nested_py != "2" {
        echo "Error: extract_json_value_py (nested) failed!"
        exit 1
    }
    echo "extract_json_value_py: PASSED"

    // Test raw unescape
    let raw_escaped_str = "He said: \\\"Hi\\\"\\nNew line with\\\\ a backslash"
    let unescaped_val = raw_unescape_json_value(raw_escaped_str)
    if unescaped_val != saying {
        echo "Error: raw_unescape_json_value failed!"
        exit 1
    }
    echo "raw_unescape_json_value: PASSED"

    // Test sed fallback extract
    let sed_json_str = "\"says\":\"He said: \\\"Hi\\\"\\nNew line with\\\\ a backslash\""
    let extracted_sed_fallback = trust extract_json_value_sed_fallback(sed_json_str, "says")
    if extracted_sed_fallback != raw_escaped_str {
        echo "Error: extract_json_value_sed_fallback failed!"
        echo "Expected: {raw_escaped_str}"
        echo "Got: {extracted_sed_fallback}"
        exit 1
    }
    echo "extract_json_value_sed_fallback: PASSED"

    // Test sed fallback for non-string value (unsupported)
    let unsupported_json_1 = "\"number_key\":123"
    let failed_1 = false
    extract_json_value_sed_fallback(unsupported_json_1, "number_key") failed {
        failed_1 = true
    }
    if not failed_1 {
        echo "Error: sed_fallback should have failed for non-string value!"
        exit 1
    }
    echo "extract_json_value_sed_fallback (non-string case): PASSED"

    // Test sed fallback for multiline value (supported)
    let multiline_json = "\"multiline_key\": \n \"multiline_value\""
    let extracted_multiline = trust extract_json_value_sed_fallback(multiline_json, "multiline_key")
    if extracted_multiline != "multiline_value" {
        echo "Error: sed_fallback failed for multiline JSON!"
        echo "Expected: multiline_value"
        echo "Got: {extracted_multiline}"
        exit 1
    }
    echo "extract_json_value_sed_fallback (multiline case): PASSED"


    echo "\n--- Testing Wrapper Functions ---"
    let escaped_wrapper = trust safe_escape_json(saying)
    if escaped_wrapper != expected_escape {
        echo "Error: safe_escape_json wrapper failed!"
        exit 1
    }
    echo "safe_escape_json (wrapper): PASSED"

    let extracted_wrapper = trust extract_json_value(json_str, "says")
    if extracted_wrapper != saying {
        echo "Error: extract_json_value wrapper (says) failed!"
        exit 1
    }
    let extracted_nested_wrapper = trust extract_json_value(json_str, "nested.a.1")
    if extracted_nested_wrapper != "2" {
        echo "Error: extract_json_value wrapper (nested) failed!"
        exit 1
    }
    echo "extract_json_value (wrapper): PASSED"

    echo "\nAll tests passed!"
}
